---
description: Histórico de debug do problema de seleção de idioma do áudio
alwaysApply: false
---

## Problema

Ao selecionar um idioma no menu (ex: Português), o vídeo é baixado sempre com o áudio no idioma **original** do vídeo, ignorando a escolha do usuário.

## CAUSA RAIZ ENCONTRADA

**Idiomas alternativos no YouTube NÃO existem como faixas de áudio separadas.**

### Como o YouTube organiza multi-áudio

| Tipo de formato | Exemplo | Idiomas | Usado por |
|---|---|---|---|
| Faixas dedicadas de áudio | `140` (m4a), `251` (opus) | **Apenas idioma original** | `ba` (best audio) |
| Streams HLS combinados (video+audio) | `95-0`, `96-2` | **Todos os idiomas** | `b` (best) |

### Evidência (vídeo de teste: `WDv4AWk0J3U`)

```
# Faixas dedicadas — só inglês (original)
140  m4a    mp4a.40.2  en    English original (default), medium
251  webm   opus       en    English original (default), medium

# Streams HLS — todos os idiomas
95-0 mp4    mp4a.40.2  es-MX   720p (Espanhol México)
95-1 mp4    mp4a.40.2  en      720p (Inglês)
95-2 mp4    mp4a.40.2  hi      720p (Hindi)
96-0 mp4    mp4a.40.2  es-MX   1080p
```

### Por que `ba[language=X]` falhava

```powershell
# FALHA — idioma alternativo não existe em faixas separadas
yt-dlp -f "ba[language=es-MX]" URL
# ERROR: Requested format is not available

# FUNCIONA — idioma original tem faixas dedicadas
yt-dlp -f "ba[language=en]" URL
# 251 webm opus en

# FUNCIONA — b (best) encontra streams HLS combinados
yt-dlp -f "b[language=es-MX][height<=720]" URL
# 95-0 mp4 mp4a.40.2 avc1.4D401F 720p es-MX
```

### Verificação com ffprobe

```
# Arquivo baixado com b[language=es-MX][height<=720]:
"codec_name": "aac"     → compatível com Windows ✓
"codec_type": "audio"
"language": "spa"       → espanhol ✓
```

## Cronologia de tentativas

### Tentativa 1 — Reordenar fallbacks ba (NÃO FUNCIONOU)

**Antes:**
```
bv+ba[ext=m4a][language=LANG] / bv+ba[ext=m4a] / bv+ba[language=LANG] / bv+ba / b
```
Problema: `ba[ext=m4a]` interceptava antes de `ba[language=LANG]`.

**Depois:**
```
bv+ba[language=LANG] / bv+ba[ext=m4a] / bv+ba / b
```
Problema: `ba[language=LANG]` FALHA para idiomas alternativos porque não existem como faixas separadas. Cai no fallback `ba[ext=m4a]` que pega o idioma original.

### Tentativa 2 — Adicionar --ppa Merger (NÃO FUNCIONOU)

Adicionado `--ppa "Merger:-c:v copy -c:a aac -b:a 192k"` para converter opus→AAC.
Problema: não resolve a seleção de idioma, só o codec. E streams HLS não passam pelo Merger.

### Tentativa 3 — Usar `b[language=X][height<=H]` (SOLUÇÃO ✓)

```
bv+ba[language=LANG] / b[language=LANG][height<=H] / bv+ba[ext=m4a] / bv+ba / b
```

**Resultado:**
- Idioma original (en): `bv+ba[language=en]` → pega faixas dedicadas (melhor qualidade: av1+opus 398+251)
- Idioma alternativo (es-MX): `ba` falha → `b[language=es-MX][height<=720]` → pega HLS combinado (95-0, h264+AAC)
- Sem idioma: `bv+ba[ext=m4a]` → prioriza AAC como antes

## Código corrigido

### youtube.go — buildFormatString

```go
func buildFormatString(height int, langCode string) string {
    h := strconv.Itoa(height)

    if langCode != "" {
        // 1) bv+ba[language=X]        → faixas dedicadas (idioma original, melhor qualidade)
        // 2) b[language=X][height<=H]  → streams HLS combinados (idiomas alternativos)
        // 3) bv+ba[ext=m4a]            → fallback sem filtro de idioma
        // 4) bv+ba / b                 → último recurso
        base := strings.SplitN(langCode, "-", 2)[0]
        if base != langCode {
            return fmt.Sprintf(
                "bv[height<=%s]+ba[language=%s]/bv[height<=%s]+ba[language=%s]/b[language=%s][height<=%s]/b[language=%s][height<=%s]/bv[height<=%s]+ba[ext=m4a]/bv[height<=%s]+ba/b[height<=%s]",
                h, langCode, h, base, langCode, h, base, h, h, h, h,
            )
        }
        return fmt.Sprintf(
            "bv[height<=%s]+ba[language=%s]/b[language=%s][height<=%s]/bv[height<=%s]+ba[ext=m4a]/bv[height<=%s]+ba/b[height<=%s]",
            h, langCode, langCode, h, h, h, h,
        )
    }

    return fmt.Sprintf("bv[height<=%s]+ba[ext=m4a]/bv[height<=%s]+ba/b[height<=%s]", h, h, h)
}
```

### youtube.go — Download (revertido, sem --ppa)

```go
cmd := exec.Command("yt-dlp",
    "-f", formatStr,
    "--merge-output-format", "mp4",
    "--embed-thumbnail",
    "--embed-metadata",
    "--newline",
    "--no-warnings",
    "-o", outputTemplate,
    videoURL,
)
```

## Limitações conhecidas

1. **Streams HLS têm qualidade inferior** — usam h264 em vez de av1/vp9, e bitrate máximo menor que faixas dedicadas.
2. **Idioma original pega qualidade máxima** — usa faixas separadas (bv+ba), permitindo av1+opus com merge.
3. **Idiomas alternativos limitados pela resolução HLS** — a qualidade máxima depende do que o YouTube disponibiliza em HLS.

## Lições aprendidas

1. `ba` (best audio) só filtra faixas de áudio **separadas** — idiomas alternativos no YouTube só existem em streams HLS **combinados** (video+audio).
2. `b[language=X][height<=H]` é a forma correta de selecionar idiomas alternativos.
3. O fallback `/` do yt-dlp funciona: quando `ba[language=X]` dá ERROR, cai automaticamente para o próximo formato.
4. Streams HLS combinados já são h264+AAC — não precisam de conversão de codec para tocar no Windows.
5. `--ppa "Merger:..."` é irrelevante para HLS combinados pois não há etapa de merge.

## Vídeo de teste

- URL: `https://www.youtube.com/watch?v=WDv4AWk0J3U`
- Idiomas: en (original), es-MX, hi
- Usado para validar a correção
